---
- name: create flannel config json
  sudo: yes
  template:
    src: 'flannel.json.j2'
    dest: /tmp/flannel.json

- name: configure flannel in etcd
  run_once: true
  sudo: yes
  command: 'curl -L http://{{ etcd_ip_address }}:4001/v2/keys/coreos.com/network/config -XPUT --data-urlencode value@/tmp/flannel.json'
  changed_when: false

- name: delete flannel config json
  file: name=/tmp/flannel.json state=absent

- name: Install flannel
  yum: name=flannel state=latest

- name: Install Flannel config file
  template: src=flanneld.j2 dest=/etc/sysconfig/flanneld
  notify:
          - restart flannel

- name: configure docker network
  sudo: yes
  lineinfile:
    dest: /etc/sysconfig/docker-network
    regexp: ^DOCKER_NETWORK_OPTIONS
    line: DOCKER_NETWORK_OPTIONS='--bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU} --dns {{ dns_server }} --dns-search {{ dns_domain }}'
    state: present
  notify:
          - restart docker

- name: Launch Flannel
  service: name=flanneld state=started enabled=yes
  notify:
          - stop docker
          - delete docker0
          - start docker

#- include: iptables.yml